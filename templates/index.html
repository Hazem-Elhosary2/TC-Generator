<!DOCTYPE html>
<html lang="{{ lang }}" dir="{% if lang == 'ar' %}rtl{% else %}ltr{% endif %}">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Test Case Generator from User Story</title>
    <style>
      :root {
        --main-navy: #14213d;
        --main-orange: #fca311;
        --light-bg: #f7fafd;
        --light-orange-bg: #fff7e6;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #f9f9f9;
        margin: 0;
        padding: 20px;
        color: #333;
      }
      body.dark-mode {
        background-color: #18191a;
        color: #eee;
      }
      .dark-mode .container {
        background: #242526;
        color: #eee;
      }
      .dark-mode table,
      .dark-mode th,
      .dark-mode td {
        background: #222;
        color: #eee;
        border-color: #444;
      }
      .dark-mode .story-details {
        background-color: #23272f;
      }
      .dark-mode .notification.success {
        background-color: #223d2c;
        color: #b6f7c1;
      }
      .dark-mode .notification.error {
        background-color: #4a2323;
        color: #ffbdbd;
      }
      .dark-mode button {
        background-color: #444;
        color: #fff;
      }
      .dark-mode button:hover {
        background-color: #222;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: #fff;
        padding: 25px 30px;
        box-shadow: 0 0 12px rgba(20, 33, 61, 0.08);
        border-radius: 8px;
        position: relative;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }
      h1 {
        font-weight: 700;
        color: var(--main-navy);
        margin: 0;
        text-align: center;
        flex-grow: 1;
      }
      .lang-toggle {
        margin-right: 10px;
      }
      label {
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
      }
      input[type="text"] {
        width: 100%;
        padding: 8px 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin-bottom: 15px;
        font-size: 1rem;
      }
      button {
        background-color: var(--main-orange);
        border: none;
        padding: 10px 16px;
        color: white;
        font-weight: 600;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        margin-right: 10px;
      }
      button:hover {
        background-color: var(--main-navy);
        color: #fff;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        text-align: right;
      }
      th,
      td {
        padding: 12px 10px;
        border: 1px solid #ddd;
      }
      th {
        background-color: var(--main-navy);
        color: #fff;
      }
      td[contenteditable="true"] {
        background-color: #fefefe;
        cursor: text;
        outline: none;
      }
      .actions button {
        margin-left: 5px;
        padding: 6px 10px;
        font-size: 0.9rem;
      }
      .story-details {
        margin-top: 20px;
        background-color: #e7f0fd;
        padding: 15px;
        border-radius: 6px;
      }
      .error {
        color: red;
        font-weight: 600;
        margin-bottom: 15px;
        text-align: center;
      }
      .notification {
        text-align: center;
        padding: 10px;
        margin-bottom: 15px;
        display: none;
        border-radius: 6px;
        transition: opacity 0.4s;
        opacity: 1;
      }
      .notification.success {
        background-color: #d4edda;
        color: #155724;
      }
      .notification.error {
        background-color: #f8d7da;
        color: #721c24;
      }
      .center {
        text-align: center;
      }
      /* loader spinner */
      .loader {
        border: 8px solid #f3f3f3;
        border-top: 8px solid var(--main-orange);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        position: fixed;
        top: 50%;
        left: 50%;
        margin: -30px 0 0 -30px;
        z-index: 1000;
        display: none;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      body[dir="ltr"] {
        direction: ltr;
        text-align: left;
      }
      body[dir="rtl"] {
        direction: rtl;
        text-align: right;
      }
      .blur-bg {
        filter: blur(4px);
        pointer-events: none;
        user-select: none;
      }
      .history-header {
        border: 2px solid #0078d4;
        background: #e7f0fd;
        color: #0078d4;
        border-radius: 8px;
        padding: 8px 18px;
        margin: 30px 0 10px 0;
        font-size: 1.2em;
        display: inline-block;
        box-shadow: 0 2px 8px #0078d41a;
      }
      .main-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--light-bg);
        border: 2px solid var(--main-navy);
        box-shadow: 0 2px 8px #14213d1a;
        border-radius: 8px;
        padding: 12px 24px;
        margin-bottom: 25px;
      }
      .main-header h1 {
        margin: 0;
        color: #0078d4;
        font-size: 1.5em;
        font-weight: 700;
      }
      .main-header-right button,
      .main-header-right form {
        display: inline-block;
        margin-left: 8px;
        vertical-align: middle;
      }
      .main-header-right button {
        border-radius: 50%;
        width: 38px;
        height: 38px;
        font-size: 1.3em;
        background: #fff;
        color: var(--main-navy);
        border: 1.5px solid var(--main-navy);
        box-shadow: 0 1px 4px #0078d41a;
        transition: background 0.2s, color 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
        margin-left: 8px;
        vertical-align: middle;
      }
      .main-header-right button:hover {
        background: var(--main-orange);
        color: #fff;
      }
      #testCasesTable {
        box-shadow: 0 2px 8px #14213d1a;
        border-radius: 8px;
        overflow: hidden;
      }
      #testCasesTable tr:hover {
        background: #f0f8ff;
      }
      .stats-bar {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin: 35px 0 10px 0;
      }
      .stat-box {
        background: var(--light-orange-bg);
        border: 2px solid var(--main-orange);
        border-radius: 10px;
        padding: 18px 28px;
        box-shadow: 0 2px 8px #0078d41a;
        text-align: center;
        min-width: 120px;
      }
      .stat-box .stat-num {
        display: block;
        font-size: 2.1em;
        font-weight: bold;
        color: var(--main-orange);
        margin-bottom: 5px;
      }
      .stat-box .stat-label {
        font-size: 1em;
        color: #333;
      }
      .stat-box.total {
        border-color: var(--main-navy);
      }
      .stat-box.current {
        border-color: #228b22;
      }
      .stat-box.auto {
        border-color: var(--main-orange);
      }
      .stat-box.current .stat-num {
        color: #228b22;
      }
      .stat-box.auto .stat-num {
        color: var(--main-orange);
      }
      .accordion.history-accordion {
        background-color: #e7f0fd;
        color: #0078d4;
        border: 2px solid #0078d4;
        border-radius: 8px;
        font-size: 1.2em;
        font-weight: bold;
        margin: 30px 0 10px 0;
        padding: 12px 18px;
        width: 100%;
        text-align: right;
        cursor: pointer;
        box-shadow: 0 2px 8px #0078d41a;
      }
      .accordion.history-accordion.active,
      .accordion.history-accordion:hover {
        background-color: #cbe3fa;
      }
      .accordion {
        background-color: #f7fafd;
        color: #0078d4;
        cursor: pointer;
        padding: 12px 18px;
        width: 100%;
        border: none;
        text-align: right;
        outline: none;
        font-size: 1.08em;
        font-weight: bold;
        border-radius: 8px;
        margin-bottom: 4px;
        transition: background 0.2s;
        position: relative;
      }
      .accordion.active,
      .accordion:hover {
        background-color: #cbe3fa;
      }
      .accordion .arrow {
        float: left;
        transition: transform 0.2s;
      }
      .accordion.active .arrow {
        transform: rotate(180deg);
      }
      .panel {
        display: none;
        overflow: hidden;
        background-color: #f7fafd;
        padding: 10px 18px;
        border-radius: 8px;
        margin-bottom: 10px;
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
      }

      .panel.active {
        display: block;
        max-height: 1000px;
        opacity: 1;
      }
      .user-stories-cards {
        margin: 30px 0 20px 0;
        background: var(--light-bg);
        border-radius: 14px;
        padding: 22px 18px 18px 18px;
        box-shadow: 0 4px 18px #14213d22;
        border: 2px solid var(--main-navy);
      }
      .cards-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 24px;
        justify-content: flex-start;
      }
      .card {
        background: var(--light-bg);
        border: 2px solid var(--main-orange);
        border-radius: 14px;
        box-shadow: 0 4px 18px var(--main-orange);
        padding: 20px 22px 16px 22px;
        min-width: 240px;
        max-width: 340px;
        flex: 1 1 240px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        transition: box-shadow 0.2s, border 0.2s, transform 0.2s;
        position: relative;
        cursor: pointer;
      }
      .card:hover {
        box-shadow: 0 8px 24px var(--main-orange);
        border-color: var(--main-navy);
        transform: translateY(-4px) scale(1.03);
      }
      .card-title {
        font-size: 1.15em;
        font-weight: bold;
        margin-bottom: 8px;
        color: var(--main-navy);
        min-height: 40px;
      }
      .story-details-card {
        max-width: 800px;
        min-width: 340px;
        margin: 0 auto 36px auto;
        box-shadow: 0 8px 32px #fca31144;
        border-width: 3px;
        padding: 32px 36px 24px 36px;
        font-size: 1.13em;
      }
      .story-details-card .card-title {
        font-size: 1.45em;
        font-weight: bold;
        color: var(--main-navy);
        margin-bottom: 8px;
        text-align: center;
      }
      .story-details-card .card-id,
      .story-details-card .card-type,
      .story-details-card .card-parent {
        font-size: 1.05em;
        color: #555;
        margin-bottom: 4px;
        text-align: center;
      }
      .story-details-card .card-sep {
        border: none;
        border-top: 1.5px solid #eee;
        margin: 18px 0 14px 0;
      }
      .card-desc-block,
      .card-accept-block {
        margin-bottom: 10px;
      }
      .card-desc-label,
      .card-accept-label {
        color: var(--main-navy);
        font-weight: 600;
        margin-bottom: 4px;
      }
      .card-desc-text,
      .card-accept-text {
        background: #f7fafd;
        border-radius: 6px;
        padding: 10px 14px;
        color: #333;
        line-height: 1.7;
        font-size: 1em;
        white-space: pre-line;
      }
      .story-details-card .card-icon {
        margin-bottom: 12px;
        text-align: center;
        width: 100%;
      }
      @media (max-width: 700px) {
        .story-details-card.big-card {
          padding: 18px 6px 14px 6px;
          font-size: 1em;
        }
      }
      .toaster {
        position: fixed;
        top: 30px;
        left: 50%;
        transform: translateX(-50%);
        min-width: 260px;
        max-width: 90vw;
        z-index: 9999;
        padding: 16px 28px;
        border-radius: 8px;
        font-size: 1.08em;
        font-weight: 600;
        text-align: center;
        display: none;
        box-shadow: 0 4px 18px #14213d33;
        transition: opacity 0.4s;
      }
      .toaster.success {
        background: #d4edda;
        color: #155724;
        border: 2px solid #228b22;
      }
      .toaster.error {
        background: #f8d7da;
        color: #721c24;
        border: 2px solid #c82333;
      }
      .popup-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
        padding-top: 60px;
      }
      .popup-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }
      .popup-close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }
      .popup-close:hover,
      .popup-close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
      .accordion.azure-pushed {
        background: #fff7e6 !important;
        border: 2px solid #fca311 !important;
        color: #fca311 !important;
        position: relative;
      }
      .accordion.azure-fetched {
        background: #e6f7ff !important;
        border: 2px solid #0078d4 !important;
        color: #0078d4 !important;
        position: relative;
      }
      .accordion.generated {
        background: #e6ffe6 !important;
        border: 2px solid #228b22 !important;
        color: #228b22 !important;
      }
      .accordion.regenerated {
        background: #fffbe6 !important;
        border: 2px solid #fca311 !important;
        color: #fca311 !important;
      }
      .azure-tag {
        background: #fca311;
        color: #fff;
        font-size: 0.9em;
        border-radius: 6px;
        padding: 2px 10px;
        margin-right: 10px;
        font-weight: bold;
        vertical-align: middle;
        display: inline-block;
      }
      .azure-tag.azure-fetched-tag {
        background: #0078d4;
        color: #fff;
      }
      .azure-tag.generated-tag {
        background: #228b22;
        color: #fff;
      }
      .azure-tag.regenerated-tag {
        background: #fca311;
        color: #fff;
      }
      /* ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ™ÿµŸÖŸäŸÖ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ÿßŸÑŸÖŸÜÿ≥ÿØŸÑÿ© */
      .dropdown-container {
        margin: 20px 0;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .dropdown-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      label {
        font-weight: bold;
        color: #333;
      }

      select {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 1rem;
        background-color: #f9f9f9;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      select:focus {
        border-color: #0078d4;
        box-shadow: 0 0 8px rgba(0, 120, 212, 0.3);
      }

      select:hover {
        border-color: #0078d4;
      }

      .dropdown-group select {
        width: 100%;
      }

      .dropdown-group label {
        margin-bottom: 5px;
        font-size: 1rem;
        color: #555;
      }

      #userStoriesSection {
        margin-top: 20px;
      }

      #userStoriesList {
        list-style-type: none;
        padding: 0;
      }

      #userStoriesList li {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-bottom: 5px;
        background-color: #f7fafd;
        transition: background-color 0.3s, box-shadow 0.3s;
      }

      #userStoriesList li:hover {
        background-color: #e7f0fd;
        box-shadow: 0 0 8px rgba(0, 120, 212, 0.3);
      }

      .status-tag {
        display: inline-block;
        padding: 4px 10px;
        font-size: 0.85em;
        font-weight: bold;
        border-radius: 6px;
        margin-left: 10px;
      }

      .status-tag.azure-pushed {
        background-color: #fca311;
        color: #fff;
      }

      .status-tag.azure-fetched {
        background-color: #0078d4;
        color: #fff;
      }

      .status-tag.generated {
        background-color: #228b22;
        color: #fff;
      }

      .status-tag.regenerated {
        background-color: #ffcc00;
        color: #333;
      }

      .user-story-card {
        background: #f7fafd;
        border: 2px solid #ccc;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .user-story-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .user-story-card.completed {
        border-color: #228b22; /* ŸÑŸàŸÜ ÿ£ÿÆÿ∂ÿ± ŸÑŸÑÿ≠ÿßŸÑÿ© Completed */
      }

      .user-story-card.in-progress {
        border-color: #0078d4; /* ŸÑŸàŸÜ ÿ£ÿ≤ÿ±ŸÇ ŸÑŸÑÿ≠ÿßŸÑÿ© In Progress */
      }

      .user-story-card.blocked {
        border-color: #c82333; /* ŸÑŸàŸÜ ÿ£ÿ≠ŸÖÿ± ŸÑŸÑÿ≠ÿßŸÑÿ© Blocked */
      }

      .user-story-card.unknown {
        border-color: #ccc; /* ŸÑŸàŸÜ ÿ±ŸÖÿßÿØŸä ŸÑŸÑÿ≠ÿßŸÑÿ© Unknown */
      }

      .card-title {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 8px;
      }

      .card-id,
      .card-status {
        font-size: 1em;
        margin-bottom: 6px;
      }

      .select-btn {
        background-color: #0078d4;
        color: #fff;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1em;
        transition: background-color 0.2s;
      }

      .select-btn:hover {
        background-color: #005a9e;
      }

      .status-circle {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        position: absolute;
        top: 10px;
        right: 10px;
      }

      .status-circle.green {
        background-color: #28a745;
      }

      .status-circle.red {
        background-color: #dc3545;
      }
    </style>
  </head>
  <body>
    <!-- loader element -->
    <div class="loader" id="loader"></div>
    <div
      id="loaderText"
      style="
        display: none;
        text-align: center;
        font-weight: bold;
        color: #0078d4;
      "
    >
      Loading...
    </div>

    <div class="container">
      <div class="main-header">
        <div class="main-header-left">
          <h1>Test Case Generator from User Story</h1>
        </div>
        <div class="main-header-right">
          <button id="darkModeBtn" type="button" title="Toggle Theme">
            ‚òÄÔ∏è
          </button>
          <button id="increaseFontBtn" type="button" title="Increase Font">
            A+
          </button>
          <button id="decreaseFontBtn" type="button" title="Decrease Font">
            A-
          </button>
          <form
            class="lang-toggle"
            method="get"
            action="/switch_language"
            style="display: inline"
          >
            <button
              type="submit"
              title="Switch Language"
              style="border-radius: 50%"
            >
              üåê
            </button>
          </form>
        </div>
      </div>

      <!-- Notification area -->
      {% if message %}
      <div class="notification success" id="flashMessage">{{ message }}</div>
      <script>
        setTimeout(() => {
          document.getElementById("flashMessage").style.display = "none";
        }, 3000);
      </script>
      {% endif %} {% if error %}
      <div class="error">{{ error }}</div>
      {% endif %}

      <!-- ÿ≠ŸÇŸÑ ÿßŸÑÿ®ÿ≠ÿ´ -->
      <div id="searchSection">
        <form method="post" action="/">
          <label for="story_id"
            >Enter Epic, Feature, or Product Backlog Item ID or URL:</label
          >
          <input
            type="text"
            id="story_id"
            name="story_id"
            value="{{ story_id }}"
            placeholder="e.g. 1234 or full URL"
            required
          />
          <button type="submit">Search</button>
        </form>
      </div>

      <!-- ŸÇÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ -->
      <div id="projectsSection" style="display: none">
        <h3>Select a Project:</h3>
        <div class="cards-wrapper" id="projectsCards"></div>
      </div>

      <!-- ŸÇÿ≥ŸÖ ÿßŸÑŸÄ Epics -->
      <div id="epicsSection" style="display: none">
        <h3>Select an Epic:</h3>
        <div class="cards-wrapper" id="epicsCards"></div>
      </div>

      <!-- ŸÇÿ≥ŸÖ ÿßŸÑŸÄ Features -->
      <div id="featuresSection" style="display: none">
        <h3>Select a Feature:</h3>
        <div class="cards-wrapper" id="featuresCards"></div>
      </div>

      <div class="dropdown-container">
        <div class="dropdown-group">
          <label for="projectsDropdown">Select a Project:</label>
          <select id="projectsDropdown" onchange="loadEpics(this.value)">
            <option value="">-- Select Project --</option>
            {% for project in projects %}
            <option value="{{ project.id }}">{{ project.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="dropdown-group" style="display: none">
          <label for="epicsDropdown">Select an Epic:</label>
          <select id="epicsDropdown" onchange="loadFeatures(this.value)">
            <option value="">-- Select Epic --</option>
          </select>
        </div>

        <div class="dropdown-group" style="display: none">
          <label for="featuresDropdown">Select a Feature:</label>
          <select id="featuresDropdown" onchange="loadUserStories(this.value)">
            <option value="">-- Select Feature --</option>
          </select>
        </div>
      </div>

      <div id="userStoriesSection" style="display: none">
        <h3>User Stories:</h3>
        <div class="cards-wrapper" id="userStoriesList"></div>
      </div>

      {% if user_stories_list and user_stories_list|length > 0 %}
      <div class="user-stories-cards">
        <h3
          style="
            margin-bottom: 18px;
            color: var(--main-navy);
            font-weight: bold;
          "
        >
          Select a User Story:
        </h3>
        <div class="cards-wrapper">
          {% for us in user_stories_list %}
          <div class="card user-story-card">
            <div class="card-content">
              <div class="card-icon">
                <span style="font-size: 2.2em; color: var(--main-orange)"
                  >üìÑ</span
                >
              </div>
              <div class="card-title">{{ us.title }}</div>
              <div class="card-id"><b>ID:</b> {{ us.id }}</div>
              {% if us.parent_title %}
              <div class="card-parent">
                <b>Parent:</b> {{ us.parent_title }}
              </div>
              {% endif %}
              <div class="card-type">
                <b>Type:</b> {{ us.parent_type or "User Story" }}
              </div>
            </div>
            <button type="button" class="select-btn" onclick="viewDetails('{{ us.id }}')">Show Details</button>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
      <div
        class="user-story-card story-details-card big-card"
        style="display: none"
      >
        <div class="card-content">
          <div class="card-icon">
            <span style="font-size: 2.7em; color: var(--main-orange)">üìÑ</span>
          </div>
          <div class="card-title">User Story Title</div>
          <div class="card-id"><b>ID:</b></div>
          <div class="card-parent"><b>Parent:</b></div>
          <div class="card-type"><b>Type:</b></div>
          <hr class="card-sep" />
          <div class="card-desc-block">
            <div class="card-desc-label"><b>Description:</b></div>
            <div class="card-desc-text">No Description</div>
          </div>
          <hr class="card-sep" />
          <div class="card-accept-block">
            <div class="card-accept-label"><b>Acceptance Criteria:</b></div>
            <div class="card-accept-text">No Acceptance Criteria</div>
          </div>
        </div>

        <!-- ŸÇÿ≥ŸÖ ÿßŸÑÿ™ÿ≥ÿ™ ŸÉŸäÿ≥ -->
        <div id="testCasesSection" style="margin-top: 20px; display: none">
          <h2>Test Cases</h2>

          <!-- ÿ≤ÿ± Generate Test Cases -->
          <div
            id="generateTestCaseButton"
            style="display: none; text-align: center; margin-bottom: 20px"
          >
            <form action="/generate" method="post" style="display: inline">
              <input type="hidden" name="story_id" id="generateStoryId" />
              <button type="submit" title="Generate Test Cases">
                Generate Test Cases
              </button>
            </form>
          </div>

          <!-- ÿ¨ÿØŸàŸÑ ÿßŸÑÿ™ÿ≥ÿ™ ŸÉŸäÿ≥ÿßÿ™ -->
          <table id="testCasesTable" dir="rtl" style="display: none">
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Steps</th>
                <th>Expected Result</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <!-- ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± -->
          <div
            id="testCasesActions"
            class="center"
            style="
              margin-top: 20px;
              display: none;
              gap: 12px;
              flex-wrap: wrap;
              justify-content: center;
            "
          >
            <form action="/export_excel" method="get" style="display: inline">
              <button type="submit" title="Export to Excel">
                Export to Excel
              </button>
            </form>
            <form
              id="pushForm"
              method="POST"
              action="/push_to_azure"
              style="display: inline"
            >
              <input type="hidden" name="story_id" id="pushStoryId" />
              <input
                type="hidden"
                id="push_mode"
                name="push_mode"
                value="update"
              />
              <button type="submit" id="pushToAzureBtn" title="Push to Azure">
                <svg
                  width="18"
                  height="18"
                  fill="none"
                  stroke="#fca311"
                  stroke-width="2"
                  viewBox="0 0 24 24"
                  style="vertical-align: middle"
                >
                  <path d="M12 19V5M5 12l7-7 7 7" />
                </svg>
                Push to Azure
              </button>
            </form>
            <form
              action="/fetch_azure_test_cases"
              method="post"
              style="display: inline"
            >
              <input type="hidden" name="story_id" id="fetchStoryId" />
              <button type="submit" title="Fetch Test Cases from Azure">
                Fetch Test Cases from Azure
              </button>
            </form>
          </div>
        </div>
      </div>

      {% if test_cases and test_cases|length > 0 %}
      <div id="testCasesSection">
        <h2>Test Cases</h2>
        <div class="stats-bar">
          <div class="stat-box total">
            <span class="stat-num">{{ total_cases }}</span>
            <span class="stat-label">Total Test Cases</span>
          </div>
          <div class="stat-box current">
            <span class="stat-num">{{ unique_stories }}</span>
            <span class="stat-label">User Stories Count</span>
          </div>
          <div class="stat-box auto">
            <span class="stat-num">{{ auto_created_cases }}</span>
            <span class="stat-label">Auto Created</span>
          </div>
        </div>
        <table id="testCasesTable" dir="rtl">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Steps</th>
              <th>Expected Result</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for tc in test_cases %}
            <tr data-id="{{ tc.id }}">
              <td>{{ tc.id }}</td>
              <td contenteditable="false" data-field="title">{{ tc.title }}</td>
              <td>
                <table
                  style="width: 100%; background: #f7fafd; border-radius: 6px"
                >
                  <thead>
                    <tr>
                      <th
                        style="
                          background: #e7f0fd;
                          color: #0078d4;
                          font-size: 0.95em;
                        "
                      >
                        Step
                      </th>
                      <th
                        style="
                          background: #e7f0fd;
                          color: #0078d4;
                          font-size: 0.95em;
                        "
                      >
                        Expected
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for s in tc.steps %}
                    <tr>
                      <td contenteditable="false">{{ s.step }}</td>
                      <td contenteditable="false">{{ s.expected }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </td>
              <td contenteditable="false" data-field="expected_result">
                {{ tc.expected_result }}
              </td>
              <td class="actions">
                <button class="editBtn" title="Edit">
                  <svg
                    width="20"
                    height="20"
                    fill="none"
                    stroke="#0078d4"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    viewBox="0 0 24 24"
                  >
                    <path d="M12 20h9" />
                    <path
                      d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19.5 3 21l1.5-4L16.5 3.5z"
                    />
                  </svg>
                </button>
                <button class="saveBtn" title="Save" style="display: none">
                  <svg
                    width="20"
                    height="20"
                    fill="none"
                    stroke="#228b22"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    viewBox="0 0 24 24"
                  >
                    <path
                      d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
                    />
                    <polyline points="17 21 17 13 7 13 7 21" />
                    <polyline points="7 3 7 8 15 8" />
                  </svg>
                </button>
                <button class="deleteBtn" title="Delete">
                  <svg
                    width="20"
                    height="20"
                    fill="none"
                    stroke="#c82333"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    viewBox="0 0 24 24"
                  >
                    <polyline points="3 6 5 6 21 6" />
                    <path
                      d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"
                    />
                    <line x1="10" y1="11" x2="10" y2="17" />
                    <line x1="14" y1="11" x2="14" y2="17" />
                  </svg>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <div
          class="center"
          style="
            margin-top: 20px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
          "
        >
          <form action="/export_excel" method="get" style="display: inline">
            <button type="submit" title="Export to Excel">
              <svg
                width="18"
                height="18"
                fill="none"
                stroke="#0078d4"
                stroke-width="2"
                viewBox="0 0 24 24"
                style="vertical-align: middle"
              >
                <path d="M12 16v-8M8 12l4 4 4-4" />
                <rect x="4" y="4" width="16" height="16" rx="2" />
              </svg>
              Export to Excel
            </button>
          </form>
          <form action="/generate" method="post" style="display: inline">
            <input type="hidden" name="story_id" value="{{ story_id }}" />
            <button type="submit" title="Regenerate">
              <svg
                width="18"
                height="18"
                fill="none"
                stroke="#228b22"
                stroke-width="2"
                viewBox="0 0 24 24"
                style="vertical-align: middle"
              >
                <path d="M4 4v6h6M20 20v-6h-6" />
                <path d="M4 20a8 8 0 0 1 16-16" />
              </svg>
              Regenerate
            </button>
          </form>
          <form
            id="pushForm"
            method="POST"
            action="/push_to_azure"
            style="display: inline"
          >
            <input type="hidden" name="story_id" value="{{ story_id }}" />
            <input
              type="hidden"
              id="push_mode"
              name="push_mode"
              value="update"
            />
            <button type="submit" id="pushToAzureBtn" title="Push to Azure">
              <svg
                width="18"
                height="18"
                fill="none"
                stroke="#fca311"
                stroke-width="2"
                viewBox="0 0 24 24"
                style="vertical-align: middle"
              >
                <path d="M12 19V5M5 12l7-7 7 7" />
              </svg>
              Push to Azure
            </button>
          </form>
          <form
            action="/fetch_azure_test_cases"
            method="post"
            style="display: inline"
          >
            <input type="hidden" name="story_id" value="{{ story_id }}" />
            <button type="submit" title="Fetch Test Cases from Azure">
              <svg
                width="18"
                height="18"
                fill="none"
                stroke="#0078d4"
                stroke-width="2"
                viewBox="0 0 24 24"
                style="vertical-align: middle"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
              Fetch Test Cases from Azure
            </button>
          </form>
          <button
            id="resetBtn"
            type="button"
            style="margin-right: 10px"
            title="Reset Data"
          >
            <svg
              width="18"
              height="18"
              fill="none"
              stroke="#c82333"
              stroke-width="2"
              viewBox="0 0 24 24"
              style="vertical-align: middle"
            >
              <path d="M3 6h18" />
              <path d="M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6" />
              <path d="M19 6l-2-2H7L5 6" />
            </svg>
            Reset Data
          </button>
        </div>
      </div>
      {% endif %}
    </div>
    <div>
      {% if logs %}
      <h3>Logs for Updating Test Case Steps</h3>
      <ul>
        {% for log in logs %}
        <li>
          Test Case ID: {{ log.test_case_id }} - Status: {{ log.status_code
          }}<br />
          XML Steps:<br />
          <pre>{{ log.steps_xml }}</pre>
        </li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>
    {% if history and history|length > 0 %}
    <button class="accordion history-accordion">
      <span style="font-size: 1.3em; vertical-align: middle">üïì</span>
      <span style="font-weight: bold">History</span>
    </button>
    <div class="panel" id="historyPanel" style="display: none">
      <div id="historyAccordion">
        {% for item in history|reverse %}
        <button class="accordion">
          <span style="color: #0078d4">üìú</span>
          {{ item.story_title }} (ID: {{ item.story_id }}) - {{ item.created_at
          }} {% if item.test_cases and item.test_cases[0].azure_pushed %}
          <span class="status-tag azure-pushed">Azure Pushed</span>
          {% elif item.test_cases and item.test_cases[0].azure_fetched %}
          <span class="status-tag azure-fetched">Azure Synced</span>
          {% elif item.test_cases and item.test_cases[0].regenerated %}
          <span class="status-tag regenerated">Regenerated</span>
          {% elif item.test_cases and item.test_cases[0].generated %}
          <span class="status-tag generated">Generated</span>
          {% endif %}
          <span class="arrow">‚ñº</span>
        </button>
        <div class="panel" style="display: none">
          <table style="width: 100%; margin-top: 10px">
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Steps</th>
                <th>Expected Result</th>
              </tr>
            </thead>
            <tbody>
              {% for tc in item.test_cases %}
              <tr>
                <td>{{ tc.id }}</td>
                <td>{{ tc.title }}</td>
                <td>
                  {% for step in tc.steps %}
                  <div>{{ step.step }} - {{ step.expected }}</div>
                  {% endfor %}
                </td>
                <td>{{ tc.expected_result }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
    <div id="notification" class="notification"></div>
    <div id="toaster" class="toaster"></div>
    <!-- ÿ£ÿπŸÑŸâ ÿßŸÑŸÄ body -->
    <div id="popupModal" class="popup-modal">
      <div class="popup-content">
        <span id="popupClose" class="popup-close">&times;</span>
        <span id="popupMessage"></span>
      </div>
    </div>
    <script>
      // Show loader on any form submit
      document.querySelectorAll("form").forEach((form) => {
        form.addEventListener("submit", function () {
          document.getElementById("loader").style.display = "block";
          document.getElementById("loaderText").style.display = "block";
          document.querySelector(".container").classList.add("blur-bg");
        });
      });

      function showNotification(message, type = "success") {
        const notification = document.getElementById("notification");
        notification.textContent = message;
        notification.className =
          "notification " + (type === "error" ? "error" : "success");
        notification.style.display = "block";
        setTimeout(() => {
          notification.style.display = "none";
        }, 3000);
      }

      // Show loader
      function showLoader() {
        document.getElementById("loader").style.display = "block";
        document.querySelector(".container").classList.add("blur-bg");
      }

      // Hide loader
      function hideLoader() {
        document.getElementById("loader").style.display = "none";
        document.querySelector(".container").classList.remove("blur-bg");
      }

      // Fetch projects on page load
      document.addEventListener("DOMContentLoaded", function () {
        showLoader();
        fetch("/api/projects")
          .then((response) => {
            if (!response.ok) throw new Error("Failed to fetch projects");
            return response.json();
          })
          .then((projects) => {
            const projectsDropdown =
              document.getElementById("projectsDropdown");
            projects.forEach((project) => {
              const option = document.createElement("option");
              option.value = project.name; // ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸÅŸÇÿ∑
              option.textContent = project.name; // ÿπÿ±ÿ∂ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸÅŸÇÿ∑
              projectsDropdown.appendChild(option);
            });
            hideLoader();
          })
          .catch((error) => {
            hideLoader();
            alert("Error fetching projects. Please try again.");
            console.error(error);
          });
      });

      let epicsDropdownInstance = null; // ÿ™ÿπÿ±ŸäŸÅ ŸÖÿ™ÿ∫Ÿäÿ± ŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿ≠ÿßŸÑÿ© Choices.js
      let featuresDropdownInstance = null; // ÿ™ÿπÿ±ŸäŸÅ ŸÖÿ™ÿ∫Ÿäÿ± ŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿ≠ÿßŸÑÿ© Choices.js

      function loadEpics(projectId) {
        if (!projectId) {
          hideLoader(); // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÑŸàÿØÿ± ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿ¥ÿ±Ÿàÿπ
          return;
        }

        showLoader(); // ÿπÿ±ÿ∂ ÿßŸÑŸÑŸàÿØÿ± ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™

        const epicsDropdown = document.getElementById("epicsDropdown");
        epicsDropdown.innerHTML = '<option value="">-- Select Epic --</option>';

        fetch(`/api/epics/${projectId}`)
          .then((response) => {
            if (!response.ok) throw new Error("Failed to fetch epics");
            return response.json();
          })
          .then((epics) => {
            console.log("Epics Data:", epics); // Debugging
            epics.forEach((epic) => {
              const option = document.createElement("option");
              option.value = epic.id;
              option.textContent = epic.title;
              epicsDropdown.appendChild(option);
            });
            document.querySelector(".dropdown-group:nth-child(2)").style.display = "block";
            hideLoader(); // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÑŸàÿØÿ± ÿ®ÿπÿØ ŸÜÿ¨ÿßÿ≠ ÿßŸÑÿπŸÖŸÑŸäÿ©
          })
          .catch((error) => {
            console.error("Error fetching epics:", error);
            alert("Error fetching epics. Please try again.");
            hideLoader(); // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÑŸàÿØÿ± ÿπŸÜÿØ ÿ≠ÿØŸàÿ´ ÿÆÿ∑ÿ£
          });
      }

      function loadFeatures(epicId) {
        if (!epicId) {
          hideLoader(); // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÑŸàÿØÿ± ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿßÿÆÿ™Ÿäÿßÿ± Epic
          return;
        }

        showLoader(); // ÿπÿ±ÿ∂ ÿßŸÑŸÑŸàÿØÿ± ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™

        const featuresDropdown = document.getElementById("featuresDropdown");
        featuresDropdown.innerHTML = '<option value="">-- Select Feature --</option>';

        fetch(`/api/features/${document.getElementById("projectsDropdown").value}/${epicId}`)
          .then((response) => {
            if (!response.ok) throw new Error("Failed to fetch features");
            return response.json();
          })
          .then((features) => {
            console.log("Features Data:", features); // Debugging
            features.forEach((feature) => {
              const option = document.createElement("option");
              option.value = feature.id;
              option.textContent = feature.title;
              featuresDropdown.appendChild(option);
            });
            document.querySelector(".dropdown-group:nth-child(3)").style.display = "block";
            hideLoader(); // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÑŸàÿØÿ± ÿ®ÿπÿØ ŸÜÿ¨ÿßÿ≠ ÿßŸÑÿπŸÖŸÑŸäÿ©
          })
          .catch((error) => {
            console.error("Error fetching features:", error);
            alert("Error fetching features. Please try again.");
            hideLoader(); // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÑŸàÿØÿ± ÿπŸÜÿØ ÿ≠ÿØŸàÿ´ ÿÆÿ∑ÿ£
          });
      }

      function loadUserStories(featureId) {
        if (!featureId) return;
        showLoader();
        const userStoriesSection = document.getElementById("userStoriesSection");
        const userStoriesList = document.getElementById("userStoriesList");
        userStoriesSection.style.display = "none";
        userStoriesList.innerHTML = "";

        fetch(`/api/user_stories/${document.getElementById("projectsDropdown").value}/${featureId}`)
          .then((response) => {
            if (!response.ok) throw new Error("Failed to fetch product backlog items");
            return response.json();
          })
          .then((productBacklogItems) => {
            productBacklogItems.forEach((item) => {
              const hasTestCases = item.test_cases && item.test_cases.length > 0;
              const statusCircle = hasTestCases
                ? '<div class="status-circle red"></div>' // ÿπŸÑÿßŸÖÿ© ÿ≠ŸÖÿ±ÿßÿ° ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ Test Cases
                : '<div class="status-circle green"></div>'; // ÿπŸÑÿßŸÖÿ© ÿÆÿ∂ÿ±ÿßÿ° ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ Test Cases

              const card = document.createElement("div");
              card.className = `card user-story-card ${item.status.toLowerCase()}`;
              card.innerHTML = `
          ${statusCircle}
          <div class="card-content">
            <div class="card-title">${item.title}</div>
            <div class="card-id"><b>ID:</b> ${item.id}</div>
            <div class="card-status"><b>Status:</b> ${item.status || "Unknown"}</div>
          </div>
          <button class="select-btn" onclick="viewDetails('${item.id}')">View Details</button>
        `;

              userStoriesList.appendChild(card);
            });
            userStoriesSection.style.display = "block";
            hideLoader();
          })
          .catch((error) => {
            hideLoader();
            alert("Error fetching product backlog items. Please try again.");
            console.error(error);
          });
      }

      function viewDetails(itemId) {
        console.log("Item ID:", itemId); // Debugging
        showLoader(); // ÿπÿ±ÿ∂ ÿßŸÑŸÑŸàÿØÿ± ÿ£ÿ´ŸÜÿßÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™

        fetch(`/api/user_story_details/${itemId}`)
          .then((response) => {
            if (!response.ok)
              throw new Error("Failed to fetch product backlog item details");
            return response.json();
          })
          .then((item) => {
            console.log("Product Backlog Item Details:", item); // Debugging

            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿÆÿßÿµ ÿ®ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
            const storyDetailsCard = document.querySelector(".story-details-card");
            storyDetailsCard.querySelector(".card-title").textContent = item.title;
            storyDetailsCard.querySelector(
              ".card-id"
            ).innerHTML = `<b>ID:</b> ${item.id}`;
            storyDetailsCard.querySelector(
              ".card-parent"
            ).innerHTML = `<b>Parent:</b> ${item.parent_title || "None"}`;
            storyDetailsCard.querySelector(
              ".card-type"
            ).innerHTML = `<b>Type:</b> ${
              item.parent_type || "Product Backlog Item"
            }`;
            storyDetailsCard.querySelector(".card-desc-text").textContent =
              item.description || "No Description";
            storyDetailsCard.querySelector(".card-accept-text").textContent =
              item.acceptance || "No Acceptance Criteria";

            // ÿπÿ±ÿ∂ ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿÆÿßÿµ ÿ®ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ
            storyDetailsCard.style.display = "block";

            // ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿ≥ŸÖ ÿßŸÑÿ™ÿ≥ÿ™ ŸÉŸäÿ≥
            const generateTestCaseButton = document.getElementById(
              "generateTestCaseButton"
            );
            const testCasesSection = document.getElementById("testCasesSection");
            const testCasesTable = document.getElementById("testCasesTable");
            const testCasesTableBody = document.querySelector(
              "#testCasesTable tbody"
            );
            const testCasesActions = document.getElementById("testCasesActions");

            testCasesTableBody.innerHTML = ""; // ÿ™ŸÅÿ±Ÿäÿ∫ ÿßŸÑÿ¨ÿØŸàŸÑ

            if (item.test_cases && item.test_cases.length > 0) {
              // ÿπÿ±ÿ∂ ÿßŸÑÿ¨ÿØŸàŸÑ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸáŸÜÿßŸÉ Test Cases
              item.test_cases.forEach((tc) => {
                const row = document.createElement("tr");
                row.innerHTML = `
            <td>${tc.id}</td>
            <td>${tc.title}</td>
            <td>
              <table style="width:100%; background: #f7fafd; border-radius:6px;">
                <tbody>
                  ${tc.steps
                    .map(
                      (step) => `
                  <tr>
                    <td>${step.step}</td>
                    <td>${step.expected}</td>
                  </tr>
                `
                    )
                    .join("")}
                </tbody>
              </table>
            </td>
            <td>${tc.expected_result}</td>
            <td>
              <button class="editBtn" title="Edit">Edit</button>
              <button class="deleteBtn" title="Delete">Delete</button>
            </td>
          `;
                testCasesTableBody.appendChild(row);
              });

              testCasesTable.style.display = "table";
              testCasesActions.style.display = "flex";
              generateTestCaseButton.style.display = "none";
            } else {
              // ÿπÿ±ÿ∂ ÿ≤ÿ± Generate Test Cases ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸáŸÜÿßŸÉ Test Cases
              testCasesTable.style.display = "none";
              testCasesActions.style.display = "none";
              generateTestCaseButton.style.display = "block";
            }

            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÄ Story ID ŸÑŸÑÿ≤ÿ±
            document.getElementById("generateStoryId").value = item.id;

            // ÿπÿ±ÿ∂ ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿÆÿßÿµ ÿ®ÿßŸÑÿ™ÿ≥ÿ™ ŸÉŸäÿ≥ÿßÿ™
            testCasesSection.style.display = "block";

            hideLoader(); // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÑŸàÿØÿ± ÿ®ÿπÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
          })
          .catch((error) => {
            hideLoader();
            alert(
              "Error fetching product backlog item details. Please try again."
            );
            console.error(error);
          });
      }

      // Accordion logic
      document
        .querySelectorAll(".accordion, .history-accordion")
        .forEach((btn) => {
          btn.addEventListener("click", function () {
            this.classList.toggle("active");
            const panel = this.nextElementSibling;
            if (panel) {
              panel.style.display =
                panel.style.display === "block" ? "none" : "block";
            }
          });
        });

      document.addEventListener("DOMContentLoaded", function () {
        // Ÿàÿ∏ŸäŸÅÿ© Edit
        document.querySelectorAll(".editBtn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const row = this.closest("tr");
            row.querySelectorAll("[contenteditable='false']").forEach((cell) => {
              cell.setAttribute("contenteditable", "true");
              cell.style.backgroundColor = "#fefefe";
            });
            row.querySelector(".saveBtn").style.display = "inline-block";
            this.style.display = "none";
          });
        });

        // Ÿàÿ∏ŸäŸÅÿ© Save
        document.querySelectorAll(".saveBtn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const row = this.closest("tr");
            const testCaseId = row.getAttribute("data-id");
            const title = row.querySelector("[data-field='title']").textContent.trim();
            const expectedResult = row.querySelector("[data-field='expected_result']").textContent.trim();
            const steps = Array.from(row.querySelectorAll("tbody tr")).map((stepRow) => ({
              step: stepRow.cells[0].textContent.trim(),
              expected: stepRow.cells[1].textContent.trim(),
            }));

            showLoader();

            fetch("/update_test_case", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                id: testCaseId,
                title,
                steps,
                expected_result: expectedResult,
              }),
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.status === "success") {
                  showNotification("Test case updated successfully!", "success");
                  row.querySelectorAll("[contenteditable='true']").forEach((cell) => {
                    cell.setAttribute("contenteditable", "false");
                    cell.style.backgroundColor = "";
                  });
                  row.querySelector(".editBtn").style.display = "inline-block";
                  this.style.display = "none";
                } else {
                  showNotification("Failed to update test case.", "error");
                }
                hideLoader();
              })
              .catch((error) => {
                console.error(error);
                showNotification("An error occurred while updating test case.", "error");
                hideLoader();
              });
          });
        });

        // Ÿàÿ∏ŸäŸÅÿ© Delete
        document.querySelectorAll(".deleteBtn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const row = this.closest("tr");
            const testCaseId = row.getAttribute("data-id");

            showLoader();

            fetch(`/delete_test_case/${testCaseId}`, { method: "POST" })
              .then((response) => response.json())
              .then((data) => {
                if (data.status === "success") {
                  showNotification("Test case deleted successfully!", "success");
                  row.remove();
                } else {
                  showNotification("Failed to delete test case.", "error");
                }
                hideLoader();
              })
              .catch((error) => {
                console.error(error);
                showNotification("An error occurred while deleting test case.", "error");
                hideLoader();
              });
          });
        });
      });

      document
        .querySelector("#generateTestCaseButton form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const formData = new FormData(this);

          showLoader(); // ÿπÿ±ÿ∂ ÿßŸÑŸÑŸàÿØÿ± ÿπŸÜÿØ ÿ®ÿØÿ° ÿßŸÑÿπŸÖŸÑŸäÿ©

          fetch("/generate", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.status === "success") {
                showNotification("Test cases generated successfully!", "success");
                updateTestCasesTable(data.test_cases);
              } else {
                showNotification(data.message || "Failed to generate test cases.", "error");
              }
              hideLoader(); // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÑŸàÿØÿ± ÿ®ÿπÿØ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ©
            })
            .catch((error) => {
              console.error(error);
              showNotification("An error occurred while generating test cases.", "error");
              hideLoader(); // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÑŸàÿØÿ± ÿπŸÜÿØ ÿ≠ÿØŸàÿ´ ÿÆÿ∑ÿ£
            });
        });

      function updateTestCasesTable(testCases) {
        const testCasesTableBody = document.querySelector("#testCasesTable tbody");
        testCasesTableBody.innerHTML = ""; // ÿ™ŸÅÿ±Ÿäÿ∫ ÿßŸÑÿ¨ÿØŸàŸÑ

        testCases.forEach((tc) => {
          const row = document.createElement("tr");
          row.setAttribute("data-id", tc.id);
          row.innerHTML = `
      <td>${tc.id}</td>
      <td contenteditable="false" data-field="title">${tc.title}</td>
      <td>
        <table style="width:100%; background: #f7fafd; border-radius:6px;">
          <tbody>
            ${tc.steps
              .map(
                (step) => `
              <tr>
                <td contenteditable="false">${step.step}</td>
                <td contenteditable="false">${step.expected}</td>
              </tr>
            `
              )
              .join("")}
          </tbody>
        </table>
      </td>
      <td contenteditable="false" data-field="expected_result">${
        tc.expected_result
      }</td>
      <td class="actions">
        <button class="editBtn" title="Edit">Edit</button>
        <button class="deleteBtn" title="Delete">Delete</button>
      </td>
    `;
          testCasesTableBody.appendChild(row);
        });

        document.getElementById("testCasesTable").style.display = "table";
        document.getElementById("testCasesActions").style.display = "flex";
        document.getElementById("generateTestCaseButton").style.display =
          "none";

        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπŸÑÿßŸÖÿ© ÿßŸÑÿØÿßÿ¶ÿ±Ÿäÿ© ŸÅŸä ÿßŸÑŸÉÿ±Ÿàÿ™
        const userStoriesList = document.getElementById("userStoriesList");
        testCases.forEach((tc) => {
          const card = userStoriesList.querySelector(`.card[data-id="${tc.story_id}"]`);
          if (card) {
            const statusCircle = card.querySelector(".status-circle");
            if (statusCircle) {
              statusCircle.className = "status-circle green"; // ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿπŸÑÿßŸÖÿ© ÿ•ŸÑŸâ ÿÆÿ∂ÿ±ÿßÿ°
            }
          }
        });
      }

      function filterDropdown(dropdownId, searchTerm) {
        const dropdown = document.getElementById(dropdownId);
        const options = dropdown.querySelectorAll("option");
        const searchTermLower = searchTerm.toLowerCase();

        options.forEach((option) => {
          if (option.textContent.toLowerCase().includes(searchTermLower)) {
            option.style.display = "block";
          } else {
            option.style.display = "none";
          }
        });
      }

      document.addEventListener("DOMContentLoaded", function () {
        const projectsDropdown = document.getElementById("projectsDropdown");

        searchInput.oninput = function () {
          filterDropdown("projectsDropdown", this.value);
        };

        projectsDropdown.parentElement.insertBefore(searchInput, projectsDropdown);
      });

      document.querySelector("#fetchStoryId").addEventListener("click", function (e) {
        e.preventDefault(); // ŸÖŸÜÿπ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        const storyId = document.getElementById("fetchStoryId").value;

        if (!storyId) {
          alert("Please enter a valid Story ID.");
          return;
        }

        showLoader(); // ÿπÿ±ÿ∂ ÿßŸÑŸÑŸàÿØÿ± ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ©

        fetch("/fetch_azure_test_cases", {
          method: "POST",
          headers: {
            "Content-Type": "application/json", // ÿ∂ÿ®ÿ∑ ŸÜŸàÿπ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
          },
          body: JSON.stringify({ story_id: storyId }), // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÉŸÄ JSON
        })
          .then((response) => {
            if (!response.ok) throw new Error("Failed to fetch test cases from Azure.");
            return response.json();
          })
          .then((data) => {
            if (data.status === "success") {
              showNotification("Test cases fetched successfully!", "success");
              updateTestCasesTable(data.test_cases); // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ¨ÿØŸàŸÑ
            } else {
              showNotification(data.message || "Failed to fetch test cases.", "error");
            }
            hideLoader(); // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÑŸàÿØÿ± ÿ®ÿπÿØ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿπŸÖŸÑŸäÿ©
          })
          .catch((error) => {
            console.error(error);
            showNotification("An error occurred while fetching test cases.", "error");
            hideLoader(); // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÑŸàÿØÿ± ÿπŸÜÿØ ÿ≠ÿØŸàÿ´ ÿÆÿ∑ÿ£
          });
      });
    </script>
  </body>
</html>
